# üìã Funcionalidade: Aumentar Vagas Dinamicamente

> **Data de Cria√ß√£o**: 2025-10-24  
> **Vers√£o**: 1.0  
> **Status**: üöß Em Desenvolvimento

---

## üéØ Objetivo

Permitir que o usu√°rio aumente dinamicamente o n√∫mero de vagas/slots em uma escala publicada quando necess√°rio, sem precisar recriar a escala ou modificar a configura√ß√£o padr√£o.

---

## üìä An√°lise de Sistemas Similares

### Padr√µes Identificados em Sistemas de Agendamento:

1. **Google Calendar / Outlook**
   - Permite "adicionar participantes" a um evento existente
   - Usa bot√£o "+" pr√≥ximo √† lista de participantes
   - ‚úÖ **Vantagem**: Visual claro e intuitivo

2. **Trello / Jira**
   - Adiciona cards/issues dinamicamente
   - Bot√£o "Add another card" sempre vis√≠vel
   - ‚úÖ **Vantagem**: A√ß√£o contextual e imediata

3. **Sistemas Hospitalares (HealthScheduler, PerfectServe)**
   - Modo "Administrador" com permiss√µes especiais
   - Bot√£o "Add Shift" ou "Duplicate Slot"
   - ‚ö†Ô∏è **Desvantagem**: Requer modo especial (complexo)

### ‚ú® Melhor Abordagem para EscalaMedica2:

Baseado na an√°lise, **N√ÉO recomendo o checkbox global**. Em vez disso, sugiro:

**Solu√ß√£o: Bot√£o "+" Inline por C√©lula**
- Cada c√©lula turno+setor+dia tem um bot√£o "+" discreto
- Ao clicar, cria um novo slot imediatamente
- Visual limpo, a√ß√£o contextual, sem mudan√ßa de modo

---

## üèóÔ∏è Arquitetura da Solu√ß√£o

### Estrutura de Dados Atual

**Tabela**: `alocacoes_template`

```sql
CREATE TABLE alocacoes_template (
    id BIGINT PRIMARY KEY,
    escala_padrao_id BIGINT,
    semana INT,           -- 1-5
    dia INT,              -- 1-7
    turno_id BIGINT,
    setor_id BIGINT,
    slot INT,             -- n√∫mero sequencial do slot
    plantonista_id BIGINT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    
    UNIQUE(escala_padrao_id, semana, dia, turno_id, setor_id, slot)
);
```

**Campo Cr√≠tico**: `slot`
- Identifica cada vaga dentro de uma combina√ß√£o (semana, dia, turno, setor)
- Ex: Se h√° 3 m√©dicos em "Segunda, Manh√£, UTI", teremos slot=1, slot=2, slot=3

---

## üîß Implementa√ß√£o Proposta

### Op√ß√£o A: Bot√£o "+" Inline (RECOMENDADA)

**Localiza√ß√£o**: Dentro de cada c√©lula da tabela, ap√≥s os slots existentes

**Fluxo**:
1. Usu√°rio clica no bot√£o "+" em uma c√©lula espec√≠fica
2. Sistema identifica o pr√≥ximo n√∫mero de slot dispon√≠vel
3. Cria um novo registro em `alocacoes_template` com `plantonista_id = NULL`
4. Recarrega a c√©lula via AJAX (ou recarrega a p√°gina)
5. Novo slot vazio aparece na c√©lula

**Vantagens**:
- ‚úÖ Contextual: a√ß√£o no local exato
- ‚úÖ Intuitiva: n√£o precisa explicar
- ‚úÖ R√°pida: 1 clique
- ‚úÖ Segura: n√£o afeta outros slots

**Desvantagens**:
- ‚ö†Ô∏è Precisa de AJAX para melhor UX
- ‚ö†Ô∏è Pode ficar visualmente polu√≠do se muitos slots

---

### Op√ß√£o B: Checkbox Global "Modo Aumentar Vagas" (SUA PROPOSTA INICIAL)

**Localiza√ß√£o**: Toggle no topo da p√°gina

**Fluxo**:
1. Usu√°rio ativa checkbox "Aumentar Vagas"
2. Sistema desabilita os selects de plantonistas
3. Usu√°rio clica em qualquer slot
4. Sistema cria novo slot vazio naquela c√©lula
5. Usu√°rio desativa checkbox para voltar ao modo normal

**Vantagens**:
- ‚úÖ Separa√ß√£o clara de modos (editar vs. aumentar)
- ‚úÖ Previne cliques acidentais
- ‚úÖ Pode adicionar v√°rios slots sem trocar de modo

**Desvantagens**:
- ‚ùå Requer troca de modo (fric√ß√£o extra)
- ‚ùå Usu√°rio pode esquecer de desativar
- ‚ùå Menos intuitivo para usu√°rios novos
- ‚ùå Clique em slot pode ser confuso (qual slot?)

---

### Op√ß√£o C: Bot√£o de Contexto no Modal (H√çBRIDA)

**Localiza√ß√£o**: Dentro do modal de cada slot

**Fluxo**:
1. Usu√°rio clica em um slot (abre modal)
2. Modal tem bot√£o "Adicionar Outro Slot Aqui"
3. Sistema cria novo slot e fecha modal
4. P√°gina recarrega mostrando novo slot

**Vantagens**:
- ‚úÖ Confirma√ß√£o impl√≠cita (usu√°rio abre modal)
- ‚úÖ N√£o precisa de modo especial
- ‚úÖ Texto explicativo no bot√£o

**Desvantagens**:
- ‚ö†Ô∏è Requer 2 cliques (abrir modal + clicar bot√£o)
- ‚ö†Ô∏è Usu√°rio precisa fechar modal para ver resultado

---

## üé® Design da Interface

### Op√ß√£o A Implementada (RECOMENDADA)

```html
<td class="slot-cell">
    <!-- Slots existentes -->
    <div class="d-flex flex-column gap-1">
        <span class="slot-badge preenchido">Dr. Jo√£o</span>
        <span class="slot-badge vago">Vago</span>
        
        <!-- Bot√£o + inline -->
        <button class="btn btn-sm btn-outline-success btn-add-slot"
                data-semana="1"
                data-dia="1"
                data-turno="3"
                data-setor="5">
            <i class="bi bi-plus-circle"></i> Adicionar Vaga
        </button>
    </div>
</td>
```

**CSS**:
```css
.btn-add-slot {
    font-size: 0.75rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    border-style: dashed;
    transition: all 0.2s;
}

.btn-add-slot:hover {
    background: rgba(25, 135, 84, 0.1);
    border-style: solid;
}
```

---

## üîå Backend - Rota e Controller

### Nova Rota

```php
// routes/web.php
Route::post('/escalas-publicadas/{escalaPublicada}/slots/add', 
    [EscalaPublicadaController::class, 'addSlot'])
    ->name('escalas-publicadas.slots.add');
```

### M√©todo do Controller

```php
// app/Http/Controllers/EscalaPublicadaController.php

/**
 * Adiciona um novo slot vazio em uma c√©lula espec√≠fica
 * 
 * @param Request $request
 * @param EscalaPublicada $escalaPublicada
 * @return \Illuminate\Http\RedirectResponse
 */
public function addSlot(Request $request, EscalaPublicada $escalaPublicada)
{
    // Valida√ß√£o
    $validated = $request->validate([
        'semana' => 'required|integer|min:1|max:5',
        'dia' => 'required|integer|min:1|max:7',
        'turno_id' => 'required|exists:turnos,id',
        'setor_id' => 'required|exists:setores,id',
    ]);

    DB::beginTransaction();
    
    try {
        // Encontrar o pr√≥ximo n√∫mero de slot dispon√≠vel
        $maxSlot = AlocacaoTemplate::where('escala_padrao_id', $escalaPublicada->escala_padrao_id)
            ->where('semana', $validated['semana'])
            ->where('dia', $validated['dia'])
            ->where('turno_id', $validated['turno_id'])
            ->where('setor_id', $validated['setor_id'])
            ->max('slot');
        
        $nextSlot = ($maxSlot ?? 0) + 1;
        
        // Criar novo slot vazio
        AlocacaoTemplate::create([
            'escala_padrao_id' => $escalaPublicada->escala_padrao_id,
            'semana' => $validated['semana'],
            'dia' => $validated['dia'],
            'turno_id' => $validated['turno_id'],
            'setor_id' => $validated['setor_id'],
            'slot' => $nextSlot,
            'plantonista_id' => null, // Vago
        ]);
        
        // Atualizar m√©tricas da escala publicada
        $escalaPublicada->refresh();
        $escalaPublicada->recalcularMetricas(); // m√©todo helper
        
        DB::commit();
        
        return redirect()
            ->route('escalas-publicadas.edit', $escalaPublicada)
            ->with('success', 'Nova vaga adicionada com sucesso!');
            
    } catch (\Exception $e) {
        DB::rollBack();
        
        return back()
            ->withErrors(['error' => 'Erro ao adicionar vaga: ' . $e->getMessage()]);
    }
}
```

---

## üîÑ M√©todo Helper para Recalcular M√©tricas

```php
// app/Models/EscalaPublicada.php

/**
 * Recalcula as m√©tricas da escala (total_slots, preenchidos, buracos, taxa)
 */
public function recalcularMetricas(): void
{
    $slots = AlocacaoTemplate::where('escala_padrao_id', $this->escala_padrao_id)->get();
    
    $this->total_slots = $slots->count();
    $this->preenchidos = $slots->whereNotNull('plantonista_id')->count();
    $this->buracos = $this->total_slots - $this->preenchidos;
    $this->taxa = $this->total_slots > 0 
        ? round(($this->preenchidos / $this->total_slots) * 100, 2) 
        : 0;
    
    $this->save();
}
```

---

## üß™ Casos de Teste

### Teste 1: Adicionar Primeira Vaga
- **Cen√°rio**: C√©lula sem slots (nova combina√ß√£o turno+setor)
- **Entrada**: semana=1, dia=1, turno_id=3, setor_id=5
- **Esperado**: Criar slot=1, plantonista_id=NULL
- **Status**: ‚úÖ Deve funcionar

### Teste 2: Adicionar Vaga em C√©lula com Slots Existentes
- **Cen√°rio**: C√©lula j√° tem slot=1 e slot=2
- **Entrada**: mesma combina√ß√£o
- **Esperado**: Criar slot=3
- **Status**: ‚úÖ Deve funcionar

### Teste 3: Verificar Unique Constraint
- **Cen√°rio**: Tentar criar slot=2 quando j√° existe
- **Entrada**: duplicar mesmo slot
- **Esperado**: Erro de unique constraint
- **Status**: ‚ö†Ô∏è Valida√ß√£o no backend previne

### Teste 4: Atualiza√ß√£o de M√©tricas
- **Cen√°rio**: Adicionar vaga e verificar total_slots
- **Entrada**: qualquer combina√ß√£o
- **Esperado**: total_slots += 1, buracos += 1
- **Status**: ‚úÖ M√©todo recalcularMetricas()

---

## üìù Valida√ß√µes e Regras de Neg√≥cio

1. **Limite M√°ximo de Slots**
   - Considerar limite de 10 slots por c√©lula?
   - Evita cria√ß√£o descontrolada
   - Implementar: `max_slots_per_cell = 10` em config

2. **Permiss√µes**
   - Apenas usu√°rios autorizados podem adicionar vagas
   - Verificar middleware de autentica√ß√£o

3. **Auditoria**
   - Registrar quem adicionou a vaga e quando
   - Adicionar campos `created_by`, `updated_by`

4. **Revers√£o**
   - Permitir remover vagas vazias?
   - Bot√£o "üóëÔ∏è" ao lado do slot vago

---

## üöÄ Roadmap de Implementa√ß√£o

### Fase 1: Backend (2-3 horas)
1. ‚úÖ Criar rota `escalas-publicadas.slots.add`
2. ‚úÖ Implementar m√©todo `addSlot()` no controller
3. ‚úÖ Criar m√©todo `recalcularMetricas()` no model
4. ‚úÖ Adicionar valida√ß√µes
5. ‚úÖ Adicionar transa√ß√£o de banco

### Fase 2: Frontend (2-3 horas)
6. ‚úÖ Adicionar bot√£o "+" em cada c√©lula da tabela
7. ‚úÖ Estilizar bot√£o (CSS dashed border)
8. ‚úÖ Criar formul√°rio inline com campos hidden
9. ‚úÖ Testar em diferentes tamanhos de tela

### Fase 3: UX Avan√ßada (Opcional - 3-4 horas)
10. üîÑ Implementar AJAX para adicionar sem reload
11. üîÑ Mostrar loading spinner durante cria√ß√£o
12. üîÑ Anima√ß√£o de fade-in para novo slot
13. üîÑ Toast notification de sucesso

### Fase 4: Refinamentos (1-2 horas)
14. üîÑ Adicionar confirma√ß√£o antes de criar
15. üîÑ Limitar n√∫mero m√°ximo de slots
16. üîÑ Bot√£o para remover vagas vazias
17. üîÑ Auditoria (created_by)

---

## ‚ö†Ô∏è Pontos de Aten√ß√£o

### Cr√≠ticos:
1. **Unique Constraint**: Garantir que `slot` seja sempre √∫nico na combina√ß√£o
2. **Transaction**: Usar DB::transaction para evitar inconsist√™ncias
3. **M√©tricas**: Sempre recalcular ap√≥s adicionar/remover slots

### Importantes:
4. **UX**: Feedback visual imediato ap√≥s adicionar
5. **Performance**: Se muitas c√©lulas, considerar lazy loading
6. **Mobile**: Bot√£o "+" deve ser clic√°vel em telas pequenas

### Desej√°veis:
7. **Auditoria**: Log de quem adicionou cada vaga
8. **Notifica√ß√µes**: Email para coordenador quando vagas aumentam
9. **Relat√≥rios**: Dashboard mostrando varia√ß√£o de vagas

---

## üîó Arquivos Relacionados

- **Migration**: `database/migrations/2025_10_21_235914_create_alocacoes_template_table.php`
- **Model**: `app/Models/AlocacaoTemplate.php`
- **Controller**: `app/Http/Controllers/EscalaPublicadaController.php`
- **View**: `resources/views/escalas-publicadas/edit.blade.php`
- **Routes**: `routes/web.php`

---

## üìö Refer√™ncias

- [Laravel Database Transactions](https://laravel.com/docs/11.x/database#database-transactions)
- [Bootstrap Icons](https://icons.getbootstrap.com/)
- [AJAX with Fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch)

---

## üìÑ Changelog

| Data | Vers√£o | Altera√ß√£o | Autor |
|------|--------|-----------|-------|
| 2025-10-24 | 1.0 | Documenta√ß√£o inicial da funcionalidade | Sistema |

---

**Status Final**: üìã Documenta√ß√£o completa. Pronto para implementa√ß√£o.
